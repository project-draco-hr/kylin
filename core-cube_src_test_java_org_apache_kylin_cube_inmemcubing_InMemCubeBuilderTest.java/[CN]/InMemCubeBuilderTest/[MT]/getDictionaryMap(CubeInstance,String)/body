{
  Map<TblColRef,Dictionary<?>> result=Maps.newHashMap();
  CubeDesc desc=cube.getDescriptor();
  CubeJoinedFlatTableDesc flatTableDesc=new CubeJoinedFlatTableDesc(desc,null);
  int nColumns=flatTableDesc.getColumnList().size();
  List<TblColRef> columns=Cuboid.getBaseCuboid(desc).getColumns();
  for (int c=0; c < columns.size(); c++) {
    TblColRef col=columns.get(c);
    if (desc.getRowkey().isUseDictionary(col)) {
      logger.info("Building dictionary for " + col);
      List<byte[]> valueList=readValueList(flatTable,nColumns,flatTableDesc.getRowKeyColumnIndexes()[c]);
      Dictionary<?> dict=DictionaryGenerator.buildDictionaryFromValueList(col.getType(),valueList);
      result.put(col,dict);
    }
  }
  for (int measureIdx=0; measureIdx < cube.getDescriptor().getMeasures().size(); measureIdx++) {
    MeasureDesc measureDesc=cube.getDescriptor().getMeasures().get(measureIdx);
    FunctionDesc func=measureDesc.getFunction();
    if (func.isTopN()) {
      int[] flatTableIdx=flatTableDesc.getMeasureColumnIndexes()[measureIdx];
      int displayColIdx=flatTableIdx[flatTableIdx.length - 1];
      TblColRef displayCol=func.getParameter().getColRefs().get(flatTableIdx.length - 1);
      logger.info("Building dictionary for " + displayCol);
      List<byte[]> valueList=readValueList(flatTable,nColumns,displayColIdx);
      Dictionary<?> dict=DictionaryGenerator.buildDictionaryFromValueList(displayCol.getType(),valueList);
      result.put(displayCol,dict);
    }
  }
  return result;
}

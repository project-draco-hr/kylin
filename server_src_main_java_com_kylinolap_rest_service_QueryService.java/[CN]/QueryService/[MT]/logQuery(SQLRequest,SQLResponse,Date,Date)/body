{
  final String user=SecurityContextHolder.getContext().getAuthentication().getName();
  final Set<String> cubeNames=new HashSet<String>();
  final Set<Long> cuboidIds=new HashSet<Long>();
  long totalScanCount=0;
  float duration=(endTime.getTime() - startTime.getTime()) / (float)1000;
  if (!response.isHitCache() && null != OLAPContext.getThreadLocalContexts()) {
    for (    OLAPContext ctx : OLAPContext.getThreadLocalContexts()) {
      for (      Cuboid cuboid : ctx.storageContext.getCuboids()) {
        String cubeName=cuboid.getCube().getName().replace("_desc","");
        cubeNames.add(cubeName);
        cuboidIds.add(cuboid.getId());
      }
      totalScanCount+=ctx.storageContext.getTotalScanCount();
    }
  }
  int resultRowCount=0;
  if (!response.getIsException() && response.getResults() != null) {
    resultRowCount=response.getResults().size();
  }
  QueryMetrics.getInstance().increase("duration",duration);
  QueryMetrics.getInstance().increase("totalScanCount",(float)totalScanCount);
  QueryMetrics.getInstance().increase("count",(float)1);
  String newLine=System.getProperty("line.separator");
  StringBuilder stringBuilder=new StringBuilder();
  stringBuilder.append(newLine);
  stringBuilder.append("==========================[QUERY]===============================").append(newLine);
  stringBuilder.append("SQL: ").append(request.getSql()).append(newLine);
  stringBuilder.append("User: ").append(user).append(newLine);
  stringBuilder.append("Success: ").append((null == response.getExceptionMessage())).append(newLine);
  stringBuilder.append("Duration: ").append(duration).append(newLine);
  stringBuilder.append("Project: ").append(request.getProject()).append(newLine);
  stringBuilder.append("Cube Names: ").append(cubeNames).append(newLine);
  stringBuilder.append("Cuboid Ids: ").append(cuboidIds).append(newLine);
  stringBuilder.append("Total scan count: ").append(totalScanCount).append(newLine);
  stringBuilder.append("Result row count: ").append(resultRowCount).append(newLine);
  stringBuilder.append("Accept Partial: ").append(request.isAcceptPartial()).append(newLine);
  stringBuilder.append("Hit Cache: ").append(response.isHitCache()).append(newLine);
  stringBuilder.append("Message: ").append(response.getExceptionMessage()).append(newLine);
  stringBuilder.append("==========================[QUERY]===============================").append(newLine);
  logger.info(stringBuilder.toString());
}

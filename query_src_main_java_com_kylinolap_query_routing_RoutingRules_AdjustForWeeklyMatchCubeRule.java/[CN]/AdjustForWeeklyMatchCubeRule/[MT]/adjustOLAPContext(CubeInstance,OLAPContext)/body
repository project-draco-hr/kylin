{
  Collection<TblColRef> dimensionColumns=CubeDimensionDeriver.getDimensionColumns(olapContext.groupByColumns,olapContext.filterColumns);
  Collection<FunctionDesc> functions=olapContext.aggregations;
  Collection<TblColRef> metricsColumns=olapContext.metricsColumns;
  Map<String,RelDataType> rewriteFields=olapContext.rewriteFields;
  CubeDesc cubeDesc=cube.getDescriptor();
  Collection<FunctionDesc> cubeFuncs=cubeDesc.listAllFunctions();
  Iterator<FunctionDesc> it=functions.iterator();
  while (it.hasNext()) {
    FunctionDesc functionDesc=it.next();
    if (!cubeFuncs.contains(functionDesc)) {
      TblColRef col=functionDesc.selectTblColByMetrics(metricsColumns,cubeDesc.getFactTable());
      functionDesc.setAppliedOnDimension(true);
      rewriteFields.remove(functionDesc.getRewriteFieldName());
      if (col != null) {
        metricsColumns.remove(col);
        dimensionColumns.add(col);
        olapContext.storageContext.addOtherMandatoryColumns(col);
      }
      logger.info("Adjust OLAPContext for " + functionDesc);
    }
  }
}

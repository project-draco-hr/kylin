{
  int alertMB=BadQueryDetector.getSystemAvailMB() * 2;
  int alertRunningSec=5;
  String mockSql="select * from just_a_test";
  final ArrayList<String[]> alerts=new ArrayList<>();
  BadQueryDetector badQueryDetector=new BadQueryDetector(alertRunningSec * 1000,alertMB,alertRunningSec,Integer.MAX_VALUE);
  badQueryDetector.registerNotifier(new BadQueryDetector.Notifier(){
    @Override public void badQueryFound(    String adj,    int runningSec,    String sql,    Thread t){
      alerts.add(new String[]{adj,sql});
    }
  }
);
  badQueryDetector.start();
{
    Thread.sleep(1000);
    SQLRequest sqlRequest=new SQLRequest();
    sqlRequest.setSql(mockSql);
    badQueryDetector.queryStart(Thread.currentThread(),sqlRequest);
    Thread.sleep((alertRunningSec * 2 + 1) * 1000);
    badQueryDetector.queryEnd(Thread.currentThread());
  }
  badQueryDetector.stop();
  assertEquals(3,alerts.size());
  assertArrayEquals(new String[]{"Low mem",mockSql},alerts.get(0));
  assertArrayEquals(new String[]{"Slow",mockSql},alerts.get(1));
  assertArrayEquals(new String[]{"Low mem",mockSql},alerts.get(2));
}

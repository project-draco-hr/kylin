{
  if (!(intermediateTableDesc instanceof CubeJoinedFlatTableDesc)) {
    return;
  }
  CubeJoinedFlatTableDesc desc=(CubeJoinedFlatTableDesc)intermediateTableDesc;
  boolean hasCondition=false;
  StringBuilder whereBuilder=new StringBuilder();
  whereBuilder.append("WHERE");
  CubeDesc cubeDesc=desc.getCubeDesc();
  if (cubeDesc.getFilterCondition() != null && cubeDesc.getFilterCondition().equals("") == false) {
    whereBuilder.append(" (").append(cubeDesc.getFilterCondition()).append(") ");
    hasCondition=true;
  }
  CubeSegment cubeSegment=desc.getCubeSegment();
  if (null != cubeSegment) {
    long dateStart=cubeSegment.getDateRangeStart();
    long dateEnd=cubeSegment.getDateRangeEnd();
    if (!(dateStart == 0 && dateEnd == Long.MAX_VALUE)) {
      String partitionColumnName=cubeDesc.getCubePartitionDesc().getPartitionDateColumn();
      int indexOfDot=partitionColumnName.lastIndexOf(".");
      if (indexOfDot > 0) {
        String partitionTableName=partitionColumnName.substring(0,indexOfDot);
        String columeOnly=partitionColumnName.substring(indexOfDot);
        String partitionTableAlias=desc.getTableAlias(partitionTableName);
        partitionColumnName=partitionTableAlias + columeOnly;
      }
      whereBuilder.append(hasCondition ? " AND (" : " (");
      if (dateStart > 0) {
        whereBuilder.append(partitionColumnName + " >= '" + formatDateTimeInWhereClause(dateStart)+ "' ");
        whereBuilder.append("AND ");
      }
      whereBuilder.append(partitionColumnName + " < '" + formatDateTimeInWhereClause(dateEnd)+ "'");
      whereBuilder.append(")\n");
      hasCondition=true;
    }
  }
  if (hasCondition) {
    sql.append(whereBuilder.toString());
  }
}

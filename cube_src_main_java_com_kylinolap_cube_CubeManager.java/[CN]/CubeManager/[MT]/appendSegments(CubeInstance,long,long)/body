{
  if (cubeInstance.getBuildingSegments().size() > 0) {
    throw new RuntimeException("There is already an allocating segment!");
  }
  List<CubeSegment> readySegments=cubeInstance.getSegments(SegmentStatusEnum.READY);
  CubeSegment newSegment;
  if (cubeInstance.getDescriptor().getCubePartitionDesc().isPartitioned()) {
    if (readySegments.isEmpty()) {
      startDate=cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart();
    }
    newSegment=newSegment(cubeInstance,startDate,endDate);
  }
 else {
    newSegment=newSegment(cubeInstance,0,Long.MAX_VALUE);
  }
  validateNewSegments(cubeInstance,newSegment);
  cubeInstance.getSegments().add(newSegment);
  Collections.sort(cubeInstance.getSegments());
  this.updateCube(cubeInstance);
  return newSegment;
}

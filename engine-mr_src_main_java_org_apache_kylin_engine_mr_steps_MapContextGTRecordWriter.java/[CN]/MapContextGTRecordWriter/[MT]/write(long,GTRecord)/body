{
  if (lastCuboidId == null || !lastCuboidId.equals(cuboidId)) {
    if (lastCuboidId != null) {
      logger.info("Cuboid " + lastCuboidId + " has "+ cuboidRowCount+ " rows");
      cuboidRowCount=0;
    }
    initVariables(cuboidId);
    lastCuboidId=cuboidId;
  }
  cuboidRowCount++;
  rowKeyEncoder.encode(record,record.getInfo().getPrimaryKey(),keyBuf);
  valueBuf.clear();
  record.exportColumns(measureColumnsIndex,valueBuf);
  outputKey.set(keyBuf,0,keyBuf.length);
  outputValue.set(valueBuf.array(),0,valueBuf.position());
  try {
    mapContext.write(outputKey,outputValue);
  }
 catch (  InterruptedException e) {
    throw new RuntimeException(e);
  }
}

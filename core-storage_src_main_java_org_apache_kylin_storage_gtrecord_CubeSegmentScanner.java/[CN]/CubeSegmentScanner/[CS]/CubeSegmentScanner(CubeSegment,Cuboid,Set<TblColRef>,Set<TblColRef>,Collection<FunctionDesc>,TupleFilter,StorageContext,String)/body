{
  this.cuboid=cuboid;
  this.cubeSeg=cubeSeg;
  byte[] serialize=TupleFilterSerializer.serialize(originalfilter,StringCodeSystem.INSTANCE);
  TupleFilter filter=TupleFilterSerializer.deserialize(serialize,StringCodeSystem.INSTANCE);
  ITupleFilterTransformer translator=new BuiltInFunctionTransformer(cubeSeg.getDimensionEncodingMap());
  filter=translator.transform(filter);
  String plannerName=KylinConfig.getInstanceFromEnv().getQueryStorageVisitPlanner();
  CubeScanRangePlanner scanRangePlanner;
  try {
    scanRangePlanner=(CubeScanRangePlanner)Class.forName(plannerName).getConstructor(CubeSegment.class,Cuboid.class,TupleFilter.class,Set.class,Set.class,Collection.class).newInstance(cubeSeg,cuboid,filter,dimensions,groups,metrics);
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  scanRequest=scanRangePlanner.planScanRequest();
  if (scanRequest != null) {
    scanRequest.setAllowStorageAggregation(context.isNeedStorageAggregation());
    scanRequest.setAggCacheMemThreshold(cubeSeg.getCubeInstance().getConfig().getQueryCoprocessorMemGB());
    scanRequest.setStorageScanRowNumThreshold(context.getThreshold());
    if (cubeSeg.getCubeDesc().supportsLimitPushDown()) {
      scanRequest.setStoragePushDownLimit(context.getStoragePushDownLimit());
    }
  }
  scanner=new ScannerWorker(cubeSeg,cuboid,scanRequest,gtStorage);
}

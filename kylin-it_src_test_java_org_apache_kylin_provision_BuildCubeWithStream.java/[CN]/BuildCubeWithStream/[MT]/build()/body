{
  clearSegment(cubeName);
  SimpleDateFormat f=new SimpleDateFormat("yyyy-MM-dd");
  f.setTimeZone(TimeZone.getTimeZone("GMT"));
  long date1=0;
  long date2=f.parse("2013-01-01").getTime();
  int numberOfRecrods1=10000;
  generateStreamData(date1,date2,numberOfRecrods1);
  ExecutableState result=buildSegment(cubeName,0,Long.MAX_VALUE);
  Assert.assertTrue(result == ExecutableState.SUCCEED);
  long date3=f.parse("2013-04-01").getTime();
  int numberOfRecords2=5000;
  generateStreamData(date2,date3,numberOfRecords2);
  result=buildSegment(cubeName,0,Long.MAX_VALUE);
  Assert.assertTrue(result == ExecutableState.SUCCEED);
  result=buildSegment(cubeName,0,Long.MAX_VALUE);
  Assert.assertTrue(result == ExecutableState.DISCARDED);
  result=mergeSegment(cubeName,0,15000);
  Assert.assertTrue(result == ExecutableState.SUCCEED);
  List<CubeSegment> segments=cubeManager.getCube(cubeName).getSegments();
  Assert.assertTrue(segments.size() == 1);
  CubeSegment toRefreshSeg=segments.get(0);
  HashMap<String,String> partitionOffsetMap=toRefreshSeg.getAdditionalInfo();
  refreshSegment(cubeName,toRefreshSeg.getSourceOffsetStart(),toRefreshSeg.getSourceOffsetEnd(),partitionOffsetMap);
  segments=cubeManager.getCube(cubeName).getSegments();
  Assert.assertTrue(segments.size() == 1);
}

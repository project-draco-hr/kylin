{
  this.serviceStartTime=System.currentTimeMillis();
  RegionScanner innerScanner=null;
  HRegion region=null;
  try {
    region=env.getRegion();
    region.startRegionOperation();
    innerScanner=region.getScanner(prepareScan(request,region));
    CoprocessorRowType type=CoprocessorRowType.deserialize(request.getType().toByteArray());
    CoprocessorProjector projector=CoprocessorProjector.deserialize(request.getProjector().toByteArray());
    EndpointAggregators aggregators=EndpointAggregators.deserialize(request.getAggregator().toByteArray());
    CoprocessorFilter filter=CoprocessorFilter.deserialize(request.getFilter().toByteArray());
    IIProtos.IIResponseInternal response=getResponse(innerScanner,type,projector,aggregators,filter);
    byte[] compressed=CompressionUtils.compress(response.toByteArray());
    IIProtos.IIResponse compressedR=IIProtos.IIResponse.newBuilder().setBlob(ByteString.copyFrom(compressed)).build();
    done.run(compressedR);
  }
 catch (  IOException ioe) {
    logger.error(ioe.toString());
    ResponseConverter.setControllerException(controller,ioe);
  }
 finally {
    IOUtils.closeQuietly(innerScanner);
    if (region != null) {
      try {
        region.closeRegionOperation();
      }
 catch (      IOException e) {
        e.printStackTrace();
        throw new RuntimeException(e);
      }
    }
  }
}

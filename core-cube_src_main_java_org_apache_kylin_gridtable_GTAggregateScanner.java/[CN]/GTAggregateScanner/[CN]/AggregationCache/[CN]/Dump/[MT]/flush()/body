{
  if (buffMap != null) {
    ObjectOutputStream oos=null;
    Object[] aggrResult=null;
    try {
      dumpedFile=File.createTempFile("KYLIN_AGGR_",".tmp");
      logger.info("AggregationCache will dump to file: " + dumpedFile.getAbsolutePath());
      oos=new ObjectOutputStream(new FileOutputStream(dumpedFile));
      oos.writeInt(buffMap.size());
      for (      Entry<byte[],MeasureAggregator[]> entry : buffMap.entrySet()) {
        MeasureAggregators aggs=new MeasureAggregators(entry.getValue());
        aggrResult=new Object[metrics.trueBitCount()];
        aggs.collectStates(aggrResult);
        ByteBuffer metricsBuf=measureCodec.encode(aggrResult);
        oos.writeObject(entry.getKey());
        oos.writeObject(BytesUtil.subarray(metricsBuf.array(),0,metricsBuf.position()));
      }
    }
  finally {
      buffMap=null;
      if (oos != null)       oos.close();
    }
  }
}

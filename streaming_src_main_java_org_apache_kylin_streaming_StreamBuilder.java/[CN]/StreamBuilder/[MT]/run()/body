{
  try {
    List<Stream> streamToBuild=Lists.newArrayList();
    clearCounter();
    while (true) {
      final Stream stream=streamQueue.poll(50,TimeUnit.MILLISECONDS);
      if (stream == null) {
        continue;
      }
 else {
        if (stream.getOffset() < 0) {
          if (!streamToBuild.isEmpty()) {
            build(streamToBuild);
          }
          logger.warn("streaming encountered EOF, stop building");
          break;
        }
      }
      streamToBuild.add(stream);
      if (streamToBuild.size() >= this.sliceSize) {
        if (build(streamToBuild)) {
          clearCounter();
          streamToBuild.clear();
        }
      }
 else       if ((System.currentTimeMillis() - lastBuildTime) > BATCH_BUILD_INTERVAL_THRESHOLD) {
        if (build(streamToBuild)) {
          clearCounter();
          streamToBuild.clear();
        }
      }
 else {
        continue;
      }
    }
  }
 catch (  InterruptedException e) {
    logger.error("StreamBuilder has been interrupted",e);
  }
}

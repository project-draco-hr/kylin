{
  try {
    List<Stream> streamToBuild=Lists.newArrayList();
    clearCounter();
    while (true) {
      Stream stream;
      try {
        stream=streamQueue.poll(10,TimeUnit.SECONDS);
      }
 catch (      InterruptedException e) {
        logger.warn("stream queue interrupted",e);
        continue;
      }
      if (stream == null) {
        logger.info("The stream queue is drained, current available stream count: " + streamToBuild.size());
        if ((System.currentTimeMillis() - lastBuildTime) > BATCH_BUILD_INTERVAL_THRESHOLD) {
          build(streamToBuild);
          clearCounter();
          streamToBuild.clear();
        }
        continue;
      }
 else {
        if (stream.getOffset() < 0) {
          if (!streamToBuild.isEmpty()) {
            build(streamToBuild);
          }
          logger.warn("streaming encountered EOF, stop building");
          break;
        }
      }
      streamToBuild.add(stream);
      if (streamToBuild.size() >= this.sliceSize) {
        build(streamToBuild);
        clearCounter();
        streamToBuild.clear();
      }
    }
  }
 catch (  Exception e) {
    logger.error("build stream error, stop building",e);
    throw new RuntimeException("build stream error, stop building",e);
  }
}

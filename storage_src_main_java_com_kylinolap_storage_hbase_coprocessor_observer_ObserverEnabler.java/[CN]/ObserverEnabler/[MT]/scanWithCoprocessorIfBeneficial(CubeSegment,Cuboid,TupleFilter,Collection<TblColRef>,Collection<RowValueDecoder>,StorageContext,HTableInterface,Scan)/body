{
  if (context.isCoprocessorEnabled() == false) {
    return table.getScanner(scan);
  }
  CoprocessorRowType type=CoprocessorRowType.fromCuboid(segment,cuboid);
  CoprocessorFilter filter=CoprocessorFilter.fromFilter(segment,tupleFiler);
  CoprocessorProjector projector=CoprocessorProjector.makeForObserver(segment,cuboid,groupBy);
  ObserverAggregators aggrs=ObserverAggregators.fromValueDecoders(rowValueDecoders);
  if (DEBUG_LOCAL_COPROCESSOR) {
    RegionScanner innerScanner=new RegionScannerAdapter(table.getScanner(scan));
    AggregationScanner aggrScanner=new AggregationScanner(type,filter,projector,aggrs,innerScanner);
    return new ResultScannerAdapter(aggrScanner);
  }
 else {
    scan.setAttribute(AggregateRegionObserver.COPROCESSOR_ENABLE,new byte[]{0x01});
    scan.setAttribute(AggregateRegionObserver.TYPE,CoprocessorRowType.serialize(type));
    scan.setAttribute(AggregateRegionObserver.PROJECTOR,CoprocessorProjector.serialize(projector));
    scan.setAttribute(AggregateRegionObserver.AGGREGATORS,ObserverAggregators.serialize(aggrs));
    scan.setAttribute(AggregateRegionObserver.FILTER,CoprocessorFilter.serialize(filter));
    return table.getScanner(scan);
  }
}

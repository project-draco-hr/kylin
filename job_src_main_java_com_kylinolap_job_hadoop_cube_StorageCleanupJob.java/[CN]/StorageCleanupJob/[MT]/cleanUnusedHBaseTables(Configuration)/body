{
  CubeManager cubeMgr=CubeManager.getInstance(KylinConfig.getInstanceFromEnv());
  HBaseAdmin hbaseAdmin=new HBaseAdmin(conf);
  String tableNamePrefix=CubeManager.getHBaseStorageLocationPrefix();
  HTableDescriptor[] tableDescriptors=hbaseAdmin.listTables(tableNamePrefix + ".*");
  List<String> allTablesNeedToBeDropped=new ArrayList<String>();
  for (  HTableDescriptor desc : tableDescriptors) {
    String host=desc.getValue(CubeManager.getHtableMetadataKey());
    if (KylinConfig.getInstanceFromEnv().getMetadataUrlPrefix().equalsIgnoreCase(host)) {
      allTablesNeedToBeDropped.add(desc.getTableName().getNameAsString());
    }
  }
  for (  CubeInstance cube : cubeMgr.listAllCubes()) {
    for (    CubeSegment seg : cube.getSegments()) {
      String tablename=seg.getStorageLocationIdentifier();
      allTablesNeedToBeDropped.remove(tablename);
      log.info("Remove table " + tablename + " from drop list, as the table belongs to cube "+ cube.getName()+ " with status "+ cube.getStatus());
    }
  }
  if (delete == true) {
    for (    String htableName : allTablesNeedToBeDropped) {
      log.info("Deleting HBase table " + htableName);
      if (hbaseAdmin.tableExists(htableName)) {
        hbaseAdmin.disableTable(htableName);
        hbaseAdmin.deleteTable(htableName);
        log.info("Deleted HBase table " + htableName);
      }
 else {
        log.info("HBase table" + htableName + " does not exist");
      }
    }
  }
 else {
    System.out.println("--------------- Tables To Be Dropped ---------------");
    for (    String htableName : allTablesNeedToBeDropped) {
      System.out.println(htableName);
    }
    System.out.println("----------------------------------------------------");
  }
  hbaseAdmin.close();
}

{
  long now=System.currentTimeMillis();
  ArrayList<Entry> entries=new ArrayList<Entry>(runningQueries.values());
  Collections.sort(entries);
  for (  Entry e : entries) {
    int runningSec=(int)((now - e.startTime) / 1000);
    if (runningSec >= alertRunningSec) {
      notify("Slow",runningSec,e.sqlRequest.getSql(),e.thread);
    }
 else {
      break;
    }
  }
  if (getSystemAvailMB() < alertMB) {
    logger.info("System free memory less than " + alertMB + " MB. "+ entries.size()+ " queries running.");
    for (    Entry e : entries) {
      int duration=(int)((now - e.startTime) / 1000);
      if (duration > killRunningSec) {
        notify("Kill",duration,e.sqlRequest.getSql(),e.thread);
        killQueryThread(e.thread);
      }
 else {
        notify("Low mem",duration,e.sqlRequest.getSql(),e.thread);
      }
    }
  }
}

{
  CubeDescManager cubeDescMgr=getCubeDescManager();
  CubeDesc desc=cubeDescMgr.getCubeDesc("test_kylin_cube_without_slr_left_join_desc");
  createNewCube(desc);
  SimpleDateFormat f=new SimpleDateFormat("yyyy-MM-dd");
  f.setTimeZone(TimeZone.getTimeZone("GMT"));
  long dateEnd=f.parse("2013-01-01").getTime();
  CubeInstance cubeInstance=cubeMgr.getCube("a_whole_new_cube");
  assertEquals(CubeStatusEnum.DISABLED,cubeInstance.getStatus());
  assertEquals(0,cubeInstance.getSegments().size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getAllocatedEndDate());
  System.out.println("Initial Build");
  CubeSegment initialSegment=cubeMgr.allocateSegments(cubeInstance,CubeBuildTypeEnum.BUILD,desc.getCubePartitionDesc().getPartitionDateStart(),dateEnd).get(0);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(CubeStatusEnum.DISABLED,cubeInstance.getStatus());
  for (  CubeSegment cubeSegment : cubeInstance.getBuildingSegments()) {
    assertEquals(CubeSegmentStatusEnum.NEW,cubeSegment.getStatus());
  }
  assertEquals(1,cubeInstance.getSegments().size());
  assertEquals(1,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getRebuildingSegments().size());
  assertTrue("".equals(initialSegment.getStorageLocationIdentifier()) == false);
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd,cubeInstance.getAllocatedEndDate());
  System.out.println("Initial Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,CubeBuildTypeEnum.BUILD,initialSegment.getName(),"job_1",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(1,cubeInstance.getSegments(CubeSegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd,cubeInstance.getAllocatedEndDate());
  System.out.println("Upsert Build");
  long start=f.parse("2013-01-01").getTime();
  long dateEnd2=f.parse("2014-01-01").getTime();
  List<CubeSegment> upsertSegments=cubeMgr.allocateSegments(cubeInstance,CubeBuildTypeEnum.BUILD,start,dateEnd2);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(1,upsertSegments.size());
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(2,cubeInstance.getSegments().size());
  assertEquals(1,cubeInstance.getSegments(CubeSegmentStatusEnum.NEW).size());
  assertEquals(1,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd2,cubeInstance.getAllocatedEndDate());
  assertEquals(start,cubeInstance.getBuildingSegments().get(0).getDateRangeStart());
  assertEquals(dateEnd2,cubeInstance.getBuildingSegments().get(0).getDateRangeEnd());
  System.out.println("Upsert Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,CubeBuildTypeEnum.BUILD,upsertSegments.get(0).getName(),"job_2",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(2,cubeInstance.getSegments().size());
  assertEquals(2,cubeInstance.getSegments(CubeSegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd2,cubeInstance.getAllocatedEndDate());
  System.out.println("Upsert Build");
  List<CubeSegment> upsertSegments3=cubeMgr.allocateSegments(cubeInstance,CubeBuildTypeEnum.BUILD,f.parse("2013-10-01").getTime(),f.parse("2014-02-01").getTime());
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(2,upsertSegments3.size());
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(4,cubeInstance.getSegments().size());
  assertEquals(2,cubeInstance.getSegments(CubeSegmentStatusEnum.NEW).size());
  assertEquals(2,cubeInstance.getBuildingSegments().size());
  assertEquals(1,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getAllocatedEndDate());
  assertEquals(f.parse("2013-01-01").getTime(),cubeInstance.getBuildingSegments().get(0).getDateRangeStart());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getBuildingSegments().get(0).getDateRangeEnd());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getBuildingSegments().get(1).getDateRangeStart());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getBuildingSegments().get(1).getDateRangeEnd());
  System.out.println("Upsert Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,CubeBuildTypeEnum.BUILD,upsertSegments3.get(1).getName(),"job_7",System.currentTimeMillis(),111L,222L,333L);
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,CubeBuildTypeEnum.BUILD,upsertSegments3.get(0).getName(),"job_6",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(3,cubeInstance.getSegments().size());
  assertEquals(3,cubeInstance.getSegments(CubeSegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getAllocatedEndDate());
  assertEquals(cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getSegments().get(0).getDateRangeStart());
  assertEquals(f.parse("2013-01-01").getTime(),cubeInstance.getSegments().get(0).getDateRangeEnd());
  assertEquals(f.parse("2013-01-01").getTime(),cubeInstance.getSegments().get(1).getDateRangeStart());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getSegments().get(1).getDateRangeEnd());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getSegments().get(2).getDateRangeStart());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getSegments().get(2).getDateRangeEnd());
}

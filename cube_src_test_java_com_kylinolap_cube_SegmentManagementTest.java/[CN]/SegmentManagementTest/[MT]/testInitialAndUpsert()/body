{
  CubeDescManager cubeDescMgr=getCubeDescManager();
  CubeDesc desc=cubeDescMgr.getCubeDesc("test_kylin_cube_without_slr_left_join_desc");
  createNewCube(desc);
  SimpleDateFormat f=new SimpleDateFormat("yyyy-MM-dd");
  f.setTimeZone(TimeZone.getTimeZone("GMT"));
  long dateEnd=f.parse("2013-11-12").getTime();
  CubeInstance cubeInstance=cubeMgr.getCube("a_whole_new_cube");
  assertEquals(RealizationStatusEnum.DISABLED,cubeInstance.getStatus());
  assertEquals(0,cubeInstance.getSegments().size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getAllocatedEndDate());
  System.out.println("Initial Build");
  CubeSegment initialSegment=cubeMgr.allocateSegments(cubeInstance,RealizationBuildTypeEnum.BUILD,desc.getCubePartitionDesc().getPartitionDateStart(),dateEnd).get(0);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(RealizationStatusEnum.DISABLED,cubeInstance.getStatus());
  for (  CubeSegment cubeSegment : cubeInstance.getBuildingSegments()) {
    assertEquals(SegmentStatusEnum.NEW,cubeSegment.getStatus());
  }
  assertEquals(1,cubeInstance.getSegments().size());
  assertEquals(1,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getRebuildingSegments().size());
  assertTrue("".equals(initialSegment.getStorageLocationIdentifier()) == false);
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd,cubeInstance.getAllocatedEndDate());
  System.out.println("Initial Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,RealizationBuildTypeEnum.BUILD,initialSegment.getName(),"job_1",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(1,cubeInstance.getSegments(SegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd,cubeInstance.getAllocatedEndDate());
  System.out.println("Upsert Build");
  long start=f.parse("2013-11-01").getTime();
  long dateEnd2=f.parse("2013-12-12").getTime();
  List<CubeSegment> upsertSegments=cubeMgr.allocateSegments(cubeInstance,RealizationBuildTypeEnum.BUILD,start,dateEnd2);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(2,upsertSegments.size());
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(3,cubeInstance.getSegments().size());
  assertEquals(2,cubeInstance.getSegments(SegmentStatusEnum.NEW).size());
  assertEquals(2,cubeInstance.getBuildingSegments().size());
  assertEquals(1,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd2,cubeInstance.getAllocatedEndDate());
  assertEquals(0L,cubeInstance.getBuildingSegments().get(0).getDateRangeStart());
  assertEquals(dateEnd2,cubeInstance.getBuildingSegments().get(1).getDateRangeEnd());
  System.out.println("Upsert Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,RealizationBuildTypeEnum.BUILD,upsertSegments.get(0).getName(),"job_2",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,RealizationBuildTypeEnum.BUILD,upsertSegments.get(1).getName(),"job_3",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(2,cubeInstance.getSegments().size());
  assertEquals(2,cubeInstance.getSegments(SegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd2,cubeInstance.getAllocatedEndDate());
  System.out.println("Upsert Build");
  long start2=f.parse("2013-12-01").getTime();
  long dateEnd3=f.parse("2013-12-31").getTime();
  List<CubeSegment> upsertSegments2=cubeMgr.allocateSegments(cubeInstance,RealizationBuildTypeEnum.BUILD,start2,dateEnd3);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(2,upsertSegments2.size());
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(4,cubeInstance.getSegments().size());
  assertEquals(2,cubeInstance.getSegments(SegmentStatusEnum.NEW).size());
  assertEquals(2,cubeInstance.getBuildingSegments().size());
  assertEquals(1,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(dateEnd3,cubeInstance.getAllocatedEndDate());
  assertEquals(f.parse("2013-11-01").getTime(),cubeInstance.getBuildingSegments().get(0).getDateRangeStart());
  assertEquals(f.parse("2013-12-01").getTime(),cubeInstance.getBuildingSegments().get(0).getDateRangeEnd());
  assertEquals(f.parse("2013-12-01").getTime(),cubeInstance.getBuildingSegments().get(1).getDateRangeStart());
  assertEquals(f.parse("2013-12-31").getTime(),cubeInstance.getBuildingSegments().get(1).getDateRangeEnd());
  System.out.println("Upsert Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,RealizationBuildTypeEnum.BUILD,upsertSegments2.get(1).getName(),"job_5",System.currentTimeMillis(),111L,222L,333L);
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,RealizationBuildTypeEnum.BUILD,upsertSegments2.get(0).getName(),"job_4",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(3,cubeInstance.getSegments().size());
  assertEquals(3,cubeInstance.getSegments(SegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(dateEnd3,cubeInstance.getAllocatedEndDate());
  assertEquals(cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getSegments().get(0).getDateRangeStart());
  assertEquals(f.parse("2013-11-01").getTime(),cubeInstance.getSegments().get(0).getDateRangeEnd());
  assertEquals(f.parse("2013-11-01").getTime(),cubeInstance.getSegments().get(1).getDateRangeStart());
  assertEquals(f.parse("2013-12-01").getTime(),cubeInstance.getSegments().get(1).getDateRangeEnd());
  assertEquals(f.parse("2013-12-01").getTime(),cubeInstance.getSegments().get(2).getDateRangeStart());
  assertEquals(f.parse("2013-12-31").getTime(),cubeInstance.getSegments().get(2).getDateRangeEnd());
  System.out.println("Upsert Build");
  List<CubeSegment> upsertSegments3=cubeMgr.allocateSegments(cubeInstance,RealizationBuildTypeEnum.BUILD,f.parse("2013-10-01").getTime(),f.parse("2014-02-01").getTime());
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(2,upsertSegments3.size());
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(5,cubeInstance.getSegments().size());
  assertEquals(2,cubeInstance.getSegments(SegmentStatusEnum.NEW).size());
  assertEquals(2,cubeInstance.getBuildingSegments().size());
  assertEquals(3,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getAllocatedEndDate());
  assertEquals(cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getBuildingSegments().get(0).getDateRangeStart());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getBuildingSegments().get(0).getDateRangeEnd());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getBuildingSegments().get(1).getDateRangeStart());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getBuildingSegments().get(1).getDateRangeEnd());
  System.out.println("Upsert Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,RealizationBuildTypeEnum.BUILD,upsertSegments3.get(1).getName(),"job_7",System.currentTimeMillis(),111L,222L,333L);
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,RealizationBuildTypeEnum.BUILD,upsertSegments3.get(0).getName(),"job_6",System.currentTimeMillis(),111L,222L,333L);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(2,cubeInstance.getSegments().size());
  assertEquals(2,cubeInstance.getSegments(SegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getAllocatedEndDate());
  assertEquals(cubeInstance.getDescriptor().getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getSegments().get(0).getDateRangeStart());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getSegments().get(0).getDateRangeEnd());
  assertEquals(f.parse("2013-10-01").getTime(),cubeInstance.getSegments().get(1).getDateRangeStart());
  assertEquals(f.parse("2014-02-01").getTime(),cubeInstance.getSegments().get(1).getDateRangeEnd());
}

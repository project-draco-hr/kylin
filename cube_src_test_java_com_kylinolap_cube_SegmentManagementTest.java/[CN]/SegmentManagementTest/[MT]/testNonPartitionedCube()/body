{
  CubeDescManager cubeDescMgr=getCubeDescManager();
  CubeDesc desc=cubeDescMgr.getCubeDesc("test_kylin_cube_without_slr_desc");
  createNewCube(desc);
  SimpleDateFormat f=new SimpleDateFormat("yyyy-MM-dd");
  f.setTimeZone(TimeZone.getTimeZone("GMT"));
  long dateEnd=f.parse("2013-11-12").getTime();
  CubeInstance cubeInstance=cubeMgr.getCube("a_whole_new_cube");
  assertEquals(CubeStatusEnum.DISABLED,cubeInstance.getStatus());
  assertEquals(0,cubeInstance.getSegments().size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getAllocatedEndDate());
  System.out.println("Initial Build");
  CubeSegment initialSegment=cubeMgr.allocateSegments(cubeInstance,CubeBuildTypeEnum.BUILD,desc.getCubePartitionDesc().getPartitionDateStart(),dateEnd).get(0);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(CubeStatusEnum.DISABLED,cubeInstance.getStatus());
  assertEquals(CubeSegmentStatusEnum.NEW,cubeInstance.getBuildingSegments().get(0).getStatus());
  assertEquals(1,cubeInstance.getSegments().size());
  assertEquals(0,cubeInstance.getSegments(CubeSegmentStatusEnum.READY).size());
  assertEquals(1,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getRebuildingSegments().size());
  assertTrue("".equals(initialSegment.getStorageLocationIdentifier()) == false);
  assertEquals("FULL_BUILD",initialSegment.getName());
  assertEquals(desc.getCubePartitionDesc().getPartitionDateStart(),cubeInstance.getAllocatedStartDate());
  assertEquals(0,cubeInstance.getAllocatedEndDate());
  System.out.println("Initial Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,CubeBuildTypeEnum.BUILD,initialSegment.getName(),"job_5",System.currentTimeMillis(),111L,222L,333L);
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(1,cubeInstance.getSegments(CubeSegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getAllocatedStartDate());
  assertEquals(0,cubeInstance.getAllocatedEndDate());
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  System.out.println("Rebuild Segment");
  CubeSegment rebuildSegment=cubeMgr.allocateSegments(cubeInstance,CubeBuildTypeEnum.BUILD,1364688000000L,1386806400000L).get(0);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(CubeSegmentStatusEnum.NEW,cubeInstance.getBuildingSegments().get(0).getStatus());
  assertEquals(1,cubeInstance.getSegments(CubeSegmentStatusEnum.READY).size());
  assertEquals(1,cubeInstance.getSegments(CubeSegmentStatusEnum.NEW).size());
  assertEquals(1,cubeInstance.getBuildingSegments().size());
  assertEquals(1,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getAllocatedStartDate());
  assertEquals(0,cubeInstance.getAllocatedEndDate());
  System.out.println("Rebuild Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,CubeBuildTypeEnum.BUILD,rebuildSegment.getName(),"job_6",System.currentTimeMillis(),111,222,333);
  assertEquals(CubeStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(1,cubeInstance.getSegments().size());
  assertEquals(1,cubeInstance.getSegments(CubeSegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getRebuildingSegments().size());
  assertEquals(0,cubeInstance.getAllocatedStartDate());
  assertEquals(0,cubeInstance.getAllocatedEndDate());
  assertEquals("job_6",cubeInstance.getSegments().get(0).getLastBuildJobID());
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
}

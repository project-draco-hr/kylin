{
  CubeInstance cubeInstance=cubeMgr.getCube("test_kylin_cube_with_slr_ready_2_segments");
  System.out.println("Merge Segment");
  CubeSegment mergedSegment=cubeMgr.allocateSegments(cubeInstance,CubeBuildTypeEnum.MERGE,1384240200000L,1386835200000L).get(0);
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(SegmentStatusEnum.NEW,cubeInstance.getBuildingSegments().get(0).getStatus());
  assertEquals(2,cubeInstance.getSegments(SegmentStatusEnum.READY).size());
  assertEquals(1,cubeInstance.getSegments(SegmentStatusEnum.NEW).size());
  assertEquals(2,cubeInstance.getMergingSegments().size());
  assertEquals(1384240200000L,cubeInstance.getAllocatedStartDate());
  assertEquals(1386835200000L,cubeInstance.getAllocatedEndDate());
  System.out.println("Build Success");
  cubeMgr.updateSegmentOnJobSucceed(cubeInstance,CubeBuildTypeEnum.MERGE,mergedSegment.getName(),"job_4",System.currentTimeMillis(),123,20000L,1216024L);
  assertEquals(RealizationStatusEnum.READY,cubeInstance.getStatus());
  assertEquals(1,cubeInstance.getSegments(SegmentStatusEnum.READY).size());
  assertEquals(0,cubeInstance.getBuildingSegments().size());
  assertEquals(0,cubeInstance.getMergingSegments().size());
  assertEquals(1384240200000L,cubeInstance.getAllocatedStartDate());
  assertEquals(1386835200000L,cubeInstance.getAllocatedEndDate());
  assertEquals("job_4",cubeInstance.getSegments().get(0).getLastBuildJobID());
  assertEquals(20000L,cubeInstance.getSegments().get(0).getSourceRecords());
  assertEquals(1216024L,cubeInstance.getSegments().get(0).getSourceRecordsSize());
  System.out.println(JsonUtil.writeValueAsIndentString(cubeInstance));
}

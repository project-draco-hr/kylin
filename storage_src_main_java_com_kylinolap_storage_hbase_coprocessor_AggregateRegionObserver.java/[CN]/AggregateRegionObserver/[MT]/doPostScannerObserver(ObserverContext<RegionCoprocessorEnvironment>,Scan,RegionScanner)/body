{
  byte[] coprocessorEnableBytes=scan.getAttribute(COPROCESSOR_ENABLE);
  if (coprocessorEnableBytes == null || coprocessorEnableBytes.length == 0 || coprocessorEnableBytes[0] == 0) {
    return innerScanner;
  }
  byte[] typeBytes=scan.getAttribute(TYPE);
  SRowType type=SRowType.deserialize(typeBytes);
  byte[] projectorBytes=scan.getAttribute(PROJECTOR);
  SRowProjector projector=SRowProjector.deserialize(projectorBytes);
  byte[] aggregatorBytes=scan.getAttribute(AGGREGATORS);
  SRowAggregators aggregators=SRowAggregators.deserialize(aggregatorBytes);
  byte[] filterBytes=scan.getAttribute(FILTER);
  SRowFilter filter=SRowFilter.deserialize(filterBytes);
  HRegion region=ctxt.getEnvironment().getRegion();
  region.startRegionOperation();
  try {
synchronized (innerScanner) {
      return new AggregationScanner(type,filter,projector,aggregators,innerScanner);
    }
  }
  finally {
    region.closeRegionOperation();
  }
}

{
  List<BlockingQueue<StreamMessage>> result=Lists.newArrayList();
  for (int partitionId=0; partitionId < partitionCount; ++partitionId) {
    final Broker leadBroker=StreamingUtil.getLeadBroker(kafkaClusterConfig,partitionId);
    final int transferredPartitionId=partitionId + partitionIdOffset;
    final long latestOffset=KafkaRequester.getLastOffset(kafkaClusterConfig.getTopic(),partitionId,OffsetRequest.LatestTime(),leadBroker,kafkaClusterConfig);
    long streamingOffset=latestOffset;
    if (partitionIdOffsetMap.containsKey(transferredPartitionId)) {
      final long earliestOffset=KafkaRequester.getLastOffset(kafkaClusterConfig.getTopic(),partitionId,OffsetRequest.EarliestTime(),leadBroker,kafkaClusterConfig);
      long committedOffset=partitionIdOffsetMap.get(transferredPartitionId);
      Preconditions.checkArgument(committedOffset <= latestOffset,String.format("invalid offset:%d, earliestOffset:%d, latestOffset:%d",committedOffset,earliestOffset,latestOffset));
      if (committedOffset < earliestOffset) {
        logger.warn(String.format("invalid offset:%d, earliestOffset:%d; Will use earliestOffset as committedOffset.",committedOffset,earliestOffset));
        committedOffset=earliestOffset;
      }
      streamingOffset=committedOffset;
    }
    logger.info("starting offset:" + streamingOffset + " cluster id:"+ clusterID+ " partitionId:"+ partitionId+ " transferredPartitionId:"+ transferredPartitionId);
    KafkaConsumer consumer=new KafkaConsumer(clusterID,kafkaClusterConfig.getTopic(),partitionId,streamingOffset,kafkaClusterConfig.getBrokers(),kafkaClusterConfig);
    Executors.newSingleThreadExecutor(new DaemonThreadFactory()).submit(consumer);
    result.add(consumer.getStreamQueue(0));
  }
  return result;
}

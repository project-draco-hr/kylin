{
  RegionScanner innerScanner=null;
  HRegion region=null;
  try {
    this.serviceStartTime=System.currentTimeMillis();
    GTScanRequest scanReq=KryoUtils.deserialize(HBaseZeroCopyByteString.zeroCopyGetBytes(request.getGtScanRequest()),GTScanRequest.class);
    RawScan hbaseRawScan=KryoUtils.deserialize(HBaseZeroCopyByteString.zeroCopyGetBytes(request.getHbaseRawScan()),RawScan.class);
    List<List<Integer>> hbaseColumnsToGT=Lists.newArrayList();
    for (    IntList intList : request.getHbaseColumnsToGTList()) {
      hbaseColumnsToGT.add(intList.getIntsList());
    }
    Scan scan=CubeHBaseRPC.buildScan(hbaseRawScan);
    region=env.getRegion();
    region.startRegionOperation();
    innerScanner=region.getScanner(scan);
    InnerScannerAsIterator cellListIterator=new InnerScannerAsIterator(innerScanner);
    IGTStore store=new HBaseReadonlyStore(cellListIterator,scanReq,hbaseRawScan.hbaseColumns,hbaseColumnsToGT,request.getRowkeyPreambleSize());
    IGTScanner rawScanner=store.scan(scanReq);
    CoprocessorBehavior behavior=CoprocessorBehavior.valueOf(request.getBehavior());
    IGTScanner finalScanner=scanReq.decorateScanner(rawScanner,behavior.ordinal() >= CoprocessorBehavior.SCAN_FILTER.ordinal(),behavior.ordinal() >= CoprocessorBehavior.SCAN_FILTER_AGGR.ordinal(),behavior.ordinal() >= CoprocessorBehavior.SCAN_FILTER_AGGR_CHECKMEM.ordinal());
    ByteBuffer buffer=ByteBuffer.allocate(RowConstants.ROWVALUE_BUFFER_SIZE);
    ByteArrayOutputStream outputStream=new ByteArrayOutputStream(RowConstants.ROWVALUE_BUFFER_SIZE);
    int finalRowCount=0;
    for (    GTRecord oneRecord : finalScanner) {
      buffer.clear();
      oneRecord.exportColumns(scanReq.getColumns(),buffer);
      buffer.flip();
      outputStream.write(buffer.array(),buffer.arrayOffset() - buffer.position(),buffer.remaining());
      finalRowCount++;
    }
    OperatingSystemMXBean operatingSystemMXBean=(OperatingSystemMXBean)ManagementFactory.getOperatingSystemMXBean();
    double systemCpuLoad=operatingSystemMXBean.getSystemCpuLoad();
    double freePhysicalMemorySize=operatingSystemMXBean.getFreePhysicalMemorySize();
    double freeSwapSpaceSize=operatingSystemMXBean.getFreeSwapSpaceSize();
    byte[] allRows=outputStream.toByteArray();
    CubeVisitProtos.CubeVisitResponse.Builder responseBuilder=CubeVisitProtos.CubeVisitResponse.newBuilder();
    done.run(responseBuilder.setCompressedRows(HBaseZeroCopyByteString.wrap(CompressionUtils.compress(allRows))).setStats(CubeVisitProtos.CubeVisitResponse.Stats.newBuilder().setAggregatedRowCount(finalScanner.getScannedRowCount() - finalRowCount).setScannedRowCount(finalScanner.getScannedRowCount()).setServiceStartTime(serviceStartTime).setServiceEndTime(System.currentTimeMillis()).setSystemCpuLoad(systemCpuLoad).setFreePhysicalMemorySize(freePhysicalMemorySize).setFreeSwapSpaceSize(freeSwapSpaceSize).setHostname(InetAddress.getLocalHost().getHostName()).build()).build());
  }
 catch (  IOException ioe) {
    logger.error(ioe.toString());
    ResponseConverter.setControllerException(controller,ioe);
  }
 finally {
    IOUtils.closeQuietly(innerScanner);
    if (region != null) {
      try {
        region.closeRegionOperation();
      }
 catch (      IOException e) {
        e.printStackTrace();
        throw new RuntimeException(e);
      }
    }
  }
}

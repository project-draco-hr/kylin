{
  try {
    Broker leadBroker=getLeadBroker();
    if (leadBroker == null) {
      logger.warn("cannot find lead broker");
    }
 else {
      final long lastOffset=KafkaRequester.getLastOffset(topic,partitionId,OffsetRequest.EarliestTime(),leadBroker,kafkaConfig);
      offset.set(lastOffset);
    }
    while (true) {
      if (leadBroker == null) {
        leadBroker=getLeadBroker();
      }
      if (leadBroker == null) {
        logger.warn("cannot find lead broker");
        continue;
      }
      final FetchResponse fetchResponse=KafkaRequester.fetchResponse(topic,partitionId,offset.get(),leadBroker,kafkaConfig);
      if (fetchResponse.errorCode(topic,partitionId) != 0) {
        logger.warn("fetch response offset:" + offset.get() + " errorCode:"+ fetchResponse.errorCode(topic,partitionId));
        continue;
      }
      for (      MessageAndOffset messageAndOffset : fetchResponse.messageSet(topic,partitionId)) {
        try {
          consume(messageAndOffset.offset(),messageAndOffset.message().payload());
        }
 catch (        Exception e) {
          logger.error("error put streamQueue",e);
          break;
        }
        offset.incrementAndGet();
      }
    }
  }
 catch (  Exception e) {
    logger.error("consumer has encountered an error",e);
  }
}

{
  FunctionDesc topnFunc=null;
  TblColRef topnLiteralCol=null;
  for (  MeasureDesc measure : cubeDesc.getMeasures()) {
    FunctionDesc func=measure.getFunction();
    if (func.isTopN() && sqlDigest.groupbyColumns.contains(func.getTopNLiteralColumn())) {
      topnFunc=func;
      topnLiteralCol=func.getTopNLiteralColumn();
    }
  }
  if (topnFunc == null)   return;
  if (sqlDigest.aggregations.size() != 1) {
    throw new IllegalStateException("When query with topN, only one metrics is allowed.");
  }
  FunctionDesc origFunc=sqlDigest.aggregations.iterator().next();
  if (origFunc.isSum() == false) {
    throw new IllegalStateException("When query with topN, only SUM function is allowed.");
  }
  sqlDigest.aggregations=Lists.newArrayList(topnFunc);
  sqlDigest.groupbyColumns.remove(topnLiteralCol);
  sqlDigest.metricColumns.add(topnLiteralCol);
  logger.info("Rewrite function " + origFunc + " to "+ topnFunc);
}

{
  if (strictChecking)   checkNoBuildingSegment(cube);
  if (cube.getDescriptor().getModel().getPartitionDesc().isPartitioned()) {
    if (startDate == 0 && startOffset == 0) {
      boolean isOffsetsOn=endOffset != 0;
      if (isOffsetsOn)       startOffset=calculateStartDateForAppendSegment(cube);
 else       startDate=calculateStartDateForAppendSegment(cube);
    }
  }
 else {
    startDate=0;
    endDate=Long.MAX_VALUE;
    startOffset=0;
    endOffset=0;
  }
  CubeSegment newSegment=newSegment(cube,startDate,endDate,startOffset,endOffset);
  validateNewSegments(cube,newSegment);
  if (saveChange) {
    CubeUpdate cubeBuilder=new CubeUpdate(cube);
    cubeBuilder.setToAddSegs(newSegment);
    updateCube(cubeBuilder);
  }
  return newSegment;
}

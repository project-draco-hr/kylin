{
  if (needsValidation) {
    query=validator.validate(query);
  }
  RelNode result=convertQueryRecursive(query,top,null).rel;
  if (top) {
    if (isStream(query)) {
      result=new LogicalDelta(cluster,result.getTraitSet(),result);
    }
  }
  RelCollation collation=RelCollations.EMPTY;
  if (!query.isA(SqlKind.DML)) {
    if (isOrdered(query)) {
      collation=requiredCollation(result);
    }
  }
  checkConvertedType(query,result);
  boolean dumpPlan=SQL2REL_LOGGER.isLoggable(Level.FINE);
  if (dumpPlan) {
    SQL2REL_LOGGER.fine(RelOptUtil.dumpPlan("Plan after converting SqlNode to RelNode",result,false,SqlExplainLevel.EXPPLAN_ATTRIBUTES));
  }
  final RelDataType validatedRowType=validator.getValidatedNodeType(query);
  return RelRoot.of(result,validatedRowType,query.getKind()).withCollation(collation);
}
